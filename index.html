<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Trip Schedule</title>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:opsz,wght@14..32,400;500;600;700;800;900&display=swap"
      rel="stylesheet"
    />

    <style>

      /* ======================================================
      base
      ====================================================== */
      html {
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        text-rendering: optimizeLegibility;
      }
      * { margin: 0; padding: 0; box-sizing: border-box; }
      html, body { 
        height: 100%; 
         overscroll-behavior: none;
      }
      body {
        font-family: var(--font-sans);
        color: var(--text);
        background: var(--bg);
        line-height: 1.5;
      }
      code, pre { font-family: var(--font-mono); }
      h1, h2 { margin: 0; font-weight: inherit; }

      input, select, textarea, button {
        font-family: inherit;
        }

      /* ======================================================
      theme / tokens
      ====================================================== */
      :root{

        --font-sans: Inter, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI Variable", "Segoe UI", "Helvetica Neue", Arial, sans-serif;

        --font-mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;

        --bg:#000000;
        --surface:#2a2b2e;
        --surface-2:#171717;
        --input:#171717;

        --text:#ffffff;
        --text-secondary:#9aa0a6;
        --text-strong:#ffffff;
        --text-muted:#9ca3af;
        --placeholder-muted: rgba(255,255,255,0.45);

        --border:#3c4043;
        --border-hover: rgba(255,255,255,0.14);

        --default:#1f1f1f;
        --default-hover:#3a3a3a;
        --primary:#007aff;
        --primary-hover:#0066d6;
        --success:#34c759;
        --warning:#ff9f0a;
        --danger:#ff3b30;
        --danger-hover:#d62e24;
        --danger-2:#ff453a;

        /* table layers */
        --table-bg: #0f1113;
        --table-header-bg: #16191d;
        --table-bus-bg: #14171b;

        --table-border: rgba(255,255,255,0.08);
        --table-border-strong: rgba(255,255,255,0.14);

        --header-text: rgba(255,255,255,0.92);
        --header-subtext: rgba(255,255,255,0.55);
        --bus-text: rgba(255,255,255,0.85);

        --radius:12px;
        --radius-sm:8px;

        --dur:160ms;
        --ease:cubic-bezier(0.2,0.8,0.2,1);
        --shadow-sm: 0 1px 0 rgba(0,0,0,0.35);
        --shadow-md: 0 8px 24px rgba(0,0,0,0.35);

        --focus-ring: 0 0 0 3px color-mix(in srgb, var(--primary) 40%, transparent);

        --topbar-h:64px;
        --container-max:1800px;
        --logo-h:40px;
        --logo-max-w:420px;
        --brand-fs-mobile: 1rem;

        --bus-row-h:96px;
        --bus-col-w:64px;
        --bar-h:84px;
        --bar-lane-step:22px;

        --blue:#3b82f6;
        --blue-2:#60a5fa;

        --tripbar-bg: rgba(59,130,246,0.22);
        --tripbar-border: rgba(96,165,250,0.55);

        --neutral-bar-bg: rgba(255,159,10,0.14);
        --neutral-bar-border: rgba(255,159,10,0.45);

        --danger-bar-bg: rgba(255,59,48,0.16);
        --danger-bar-border: rgba(255,69,58,0.55);

        --conflict-bg: rgba(255,69,58,0.12);
        --conflict-accent: rgba(255,69,58,0.65);

        /* field typography */
        --field-font-family: var(--font-sans);
        --field-font-size: 14px;
        --field-font-weight: 400;
        --field-line-height: 1.4;
        --field-letter-spacing: 0.01em;

        /* controls */
        --control-h: 36px;
        --control-radius: 10px;
        --control-pad-x: 14px;
        --control-pad-y: 8px;

        --control-h-sm: 36px;
        --control-radius-sm: 10px;
        --control-pad-x-sm: 12px;

        /* buttons */
        --btn-h: var(--control-h);
        --btn-radius: var(--control-radius);
        --btn-pad-x: 14px;

        --btn-h-sm: var(--control-h-sm);
        --btn-radius-sm: var(--control-radius-sm);
        --btn-pad-x-sm: 12px;

      }

      /* ======================================================
      typography
      ====================================================== */
      .help{
        color: var(--text-muted);
        font-size: 10px;
        margin-top: 0.25rem;
      }
      label{
        font-family: var(--font-sans);
        font-size: 13px;
        font-weight: 400;
        letter-spacing: 0.02px;
        color: rgba(255,255,255,0.55);
      }
      .section-title {
        font-size: 15px;
        font-weight: 600;
        letter-spacing: 0.02px;
        color: var(--text-strong);
        line-height: 20px;
        padding-bottom: 2px;
      }

      /* ======================================================
      layout
      ====================================================== */
      .app{
        min-height: 100vh;
        display: grid;
        grid-template-rows: var(--topbar-h) 1fr;
      }
      .main{ padding: 0 16px 16px; }
      .container{
        max-width: var(--container-max);
        margin: 0 auto;
      }
      .is-hidden{ display:none !important; }

      /* ======================================================
      topbar
      ====================================================== */
      .topbar{
        position: sticky;
        top: 0;
        z-index: 20;
        border-bottom: 1px solid var(--bg);
        background: transparent;
        backdrop-filter: blur(10px);
      }
      .topbar-inner{
        max-width: var(--container-max);
        margin: 0 auto;
        height: var(--topbar-h);
        padding: 0 16px;
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:14px;
      }
      .brand{
        display:flex;
        flex:1 1 auto;
        align-items:center;
        gap:12px;
        min-width:0;
      }
      .logo-wrap{
        display:flex;
        align-items:center;
        flex:0 0 auto;
        min-width:0;
      }
      .logo-img{
        height: var(--logo-h);
        width:auto;
        max-width: var(--logo-max-w);
        display:block;
        object-fit:contain;
      }
      .logo-placeholder{
        height: var(--logo-h);
        padding: 0 14px;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: linear-gradient(135deg, rgba(0,122,255,0.22), rgba(255,255,255,0.02));
        display:inline-flex;
        align-items:center;
        justify-content:center;
        font-weight: 900;
        color: var(--primary);
        user-select:none;
        white-space:nowrap;
      }
      .brand-title {
        font-size: 22px;
        font-weight: 600;
        letter-spacing: 0.2px;
        color: var(--text-strong);
        line-height: 28px;
      }
      .top-actions{
        display:flex;
        flex:0 0 auto;
        align-items:center;
        gap:10px;
        flex-wrap:wrap;
        justify-content:flex-end;
      }

      /* week start toggle pill */
      .weekstart-toggle{
        display:inline-flex;
        align-items:center;
        gap:8px;
        min-height: var(--control-h-sm);
        padding: 0 12px;
        border: 1px solid var(--border);
        border-radius: 999px;
        background: rgba(255,255,255,0.03);
        color: var(--text-muted);
        font-size: 12px;
        font-weight: 700;
        letter-spacing: 0.02em;
        user-select: none;
        white-space: nowrap;
      }
      .weekstart-toggle input{
        accent-color: var(--primary);
        margin: 0;
        transform: translateY(1px);
      }

        /* ======================================================
        cards
        ====================================================== */
        .card{
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px;
            min-width: 0;
        }
        .card.compact{ padding: 16px; }
        .card-title{
            display:flex;
            align-items:center;
            gap:10px;
            flex-wrap:wrap;
            min-width:0;
        }
        .card-content{
            color: var(--text-muted);
            font-size: 0.95rem;
            min-width:0;
        }
        .card-head{
            display:flex;
            align-items:center;
            justify-content:space-between;
            gap:12px;
            margin-bottom: 10px;
            min-height: var(--btn-h);
        }
        .card-head-actions{
            display:flex;
            align-items:center;
            gap:8px;
        }

          /* weekly schedule header layout */
        .schedule-header{
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            flex-wrap: wrap; /* allows wrapping on small screens */
        }

        .week-controls--title{
            display: inline-flex;
            align-items: center;
            gap: 10px;
            margin-left: auto; /* pushes controls to the right */
        }

        @media (max-width: 600px){
            .week-controls--title{
                width: 100%;
                justify-content: flex-end;
            }
        }

      /* ======================================================
      forms
      ====================================================== */
      input, select, textarea{
        font-family: var(--field-font-family);
        font-size: var(--field-font-size);
        font-weight: var(--field-font-weight);
        line-height: var(--field-line-height);
        letter-spacing: var(--field-letter-spacing);
        color: var(--text);
      }
      ::placeholder{
        font-family: var(--field-font-family);
        font-size: var(--field-font-size);
        font-weight: var(--field-font-weight);
        line-height: var(--field-line-height);
        letter-spacing: var(--field-letter-spacing);
        color: var(--placeholder-muted);
        opacity: 1;
      }

      input[type="text"],
      input[type="tel"],
      input[type="date"],
      input[type="time"],
      input[type="number"],
      select{
        background: var(--input);
        border: 1px solid var(--border);
        border-radius: var(--control-radius);
        height: var(--control-h);
        padding: 0 var(--control-pad-x);
        line-height: var(--control-h);
        width: 100%;
        max-width: 100%;
        transition: border-color 0.15s ease, background 0.15s ease;
      }

      textarea{
        background: var(--input);
        border: 1px solid var(--border);
        border-radius: var(--control-radius);
        width: 100%;
        max-width: 100%;
        min-height: 120px;
        padding: 10px var(--control-pad-x);
        resize: vertical;
      }

      input:focus, select:focus, textarea:focus{
        border-color: var(--primary);
        background: var(--bg);
        outline: none;
        box-shadow: var(--focus-ring);
      }

      body input[type="date"]::-webkit-calendar-picker-indicator,
      body input[type="time"]::-webkit-calendar-picker-indicator{
        filter: invert(1);
        opacity: 0.85;
        cursor: pointer;
      }
      input[type="date"]:focus::-webkit-calendar-picker-indicator,
      input[type="time"]:focus::-webkit-calendar-picker-indicator{ opacity: 1; }

      input.is-empty,
      textarea.is-empty,
      select.is-empty{ color: var(--placeholder-muted); }

      select:required:invalid{ color: var(--placeholder-muted); }
      select:required:valid{ color: var(--text); }
      select option{ color: var(--text); }

      input:-webkit-autofill,
      input:-webkit-autofill:hover,
      input:-webkit-autofill:focus{
        -webkit-text-fill-color: var(--text);
        box-shadow: 0 0 0px 1000px var(--input) inset;
        transition: background-color 9999s ease-in-out 0s;
      }

      .form-grid{
        display:grid;
        grid-template-columns: repeat(12, 1fr);
        gap: 12px;
      }
      .form-group{
        display:flex;
        flex-direction:column;
        gap: 6px;
        min-width:0;
      }
      .col-1  { grid-column: span 1; }
      .col-2  { grid-column: span 2; }
      .col-3  { grid-column: span 3; }
      .col-4  { grid-column: span 4; }
      .col-5  { grid-column: span 5; }
      .col-6  { grid-column: span 6; }
      .col-7  { grid-column: span 7; }
      .col-8  { grid-column: span 8; }
      .col-9  { grid-column: span 9; }
      .col-10 { grid-column: span 10; }
      .col-11 { grid-column: span 11; }
      .col-12 { grid-column: span 12; }

      .subsection{
        grid-column: 1 / -1;
        margin-top: 6px;
        padding-top: 14px;
        border-top: 1px solid var(--border);
      }
      .subsection-head{
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap: 12px;
        margin-bottom: 10px;
      }
      .subsection-grid{
        display:grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 12px;
      }

      .form-actions{
        grid-column: 1 / -1;
        display:flex;
        flex-wrap:wrap;
        gap:10px;
        align-items:center;
        margin-top:14px;
        padding-top:14px;
        border-top:1px solid var(--border);
      }
      .form-actions #itineraryBtn{ margin-left: auto; }
      .form-actions #deleteBtn{ margin-left: 10px; }

      select.status-pending {
        background: rgba(255, 59, 48, 0.16);
        border-color: rgba(255, 59, 48, 0.6);
        color: #ffd6d3;
      }
      select.status-ok {
        background: rgba(52, 199, 89, 0.18);
        border-color: rgba(52, 199, 89, 0.6);
        color: #eafff1;
      }

      input[type="date"].weekpicker{
        height: var(--control-h-sm);
        width: 170px;
        max-width: 170px;
        padding: 0 var(--control-pad-x-sm);
        border-radius: var(--control-radius-sm);
        box-sizing: border-box;
        -webkit-appearance: none;
        appearance: none;
        line-height: var(--control-h-sm);
      }

      /* ======================================================
      buttons
      ====================================================== */
      button,
      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;

        min-height: var(--btn-h);
        padding: 0 14px;
        border-radius: 10px;

        font-family: var(--font-sans);
        font-size: 14px;
        font-weight: 500;
        letter-spacing: 0.01em;
        line-height: 1;

        color: var(--text-strong);
        background: rgba(255,255,255,0.06);
        border: 1px solid rgba(255,255,255,0.14);

        box-shadow: var(--shadow-sm);
        cursor: pointer;
        white-space: nowrap;

        transition:
          background var(--dur) var(--ease),
          border-color var(--dur) var(--ease),
          box-shadow var(--dur) var(--ease),
          transform var(--dur) var(--ease);
      }
      button:hover,
      .btn:hover {
        background: rgba(255,255,255,0.10);
        border-color: rgba(255,255,255,0.22);
      }
      button:active,
      .btn:active {
        transform: translateY(1px);
        box-shadow: none;
      }
      button:focus-visible,
      .btn:focus-visible {
        outline: none;
        box-shadow: var(--focus-ring);
      }
      button:disabled,
      .btn:disabled {
        opacity: 0.45;
        cursor: not-allowed;
        box-shadow: none;
        background: rgba(255,255,255,0.04);
        border-color: var(--border);
        color: var(--text-muted);
      }
      .btn-primary {
        background: var(--primary);
        border-color: var(--primary);
        color: #fff;
      }
      .btn-primary:hover {
        background: var(--primary-hover);
        border-color: var(--primary-hover);
      }
      #deleteBtn {
        background: rgba(255, 59, 48, 0.12);
        border-color: rgba(255, 59, 48, 0.45);
        color: #ff9a94;
      }
      #deleteBtn:hover {
        background: rgba(255, 59, 48, 0.18);
        border-color: rgba(255, 59, 48, 0.7);
      }
      .btn-compact { min-height: var(--btn-h-sm); border-radius: var(--btn-radius-sm); }

      /* ======================================================
      badges
      ====================================================== */
      .badge{
        display:inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: var(--radius);
        font-size: 0.85rem;
        font-weight: 700;
      }
      .badge-primary{ background: rgba(0,122,255,0.2); color: var(--primary); }
      .badge-error{ background: rgba(255,69,58,0.1); color: var(--danger-2); }

      /* ======================================================
      scheduler layout
      ====================================================== */
        .scheduler-layout{
            display:grid;
            grid-template-columns: minmax(420px, 480px) 1fr;
            gap: 12px;
            align-items: start;
        }
        .scheduler-layout.is-collapsed{ grid-template-columns: 1fr; }
        .scheduler-left, .scheduler-right{ min-width:0; }

        @media (min-width:1100px){
            .scheduler-left .card{
            position: sticky;
            top: calc(var(--topbar-h) + 20px);
            }
        }
        @media (max-width:1100px){
            .scheduler-layout{ grid-template-columns: 1fr; }
        }

        @media (max-width: 700px){
            .week-table thead th .day-date{
                display:none;
        }
        .week-table thead th .day-name{
                font-size: 14px;
            }
        }

      #tripDetailsModal,
      #tripDetailsModal * ,
      #itineraryModal,
      #itineraryModal * {
        -webkit-user-select: text;
        user-select: text;
        -webkit-touch-callout: default;
      }

      /* ======================================================
      tables
      ====================================================== */
      .week-table-container{
        margin-top: 1rem;
        width:100%;
        background: var(--surface-2);
        overflow-x:hidden;
        -webkit-overflow-scrolling: touch;
      }
      .week-table{
        width:100%;
        table-layout:fixed;
        border-collapse:separate;
        border-spacing:0;
        background: var(--surface-2);
        border:1px solid var(--border);
        box-sizing:border-box;
        min-width: 0px;
      }
      .week-table th, .week-table td{
        border-right:1px solid var(--border);
        border-bottom:1px solid var(--border);
        text-align:center;
        vertical-align:middle;
      }
      .week-table tr > *:last-child{ border-right:none; }

      .week-table thead th{
        height: 64px;
        padding: 0px;
        line-height:1.1;
        position: sticky;
        top:0;
        z-index:3;
        font-weight:700;
        white-space:nowrap;
        background: var(--surface-2);
        color: var(--header-text);
        border-bottom: 1px solid var(--table-border-strong);
      }

      .week-table th:first-child{
        position: sticky;
        left:0;
        z-index:11;
        background: var(--surface-2);
        border-right: 1px solid var(--border-hover);
        text-align:center;
        font-weight:800;
        letter-spacing:0.3px;
      }
      .week-table td:first-child{
        position: sticky;
        left:0;
        z-index:10;
        text-align:center;
        font-weight:600;
        letter-spacing:0.3px;
      }

      .week-table thead th .day-name{
        display:block;
        font-size:16px;
        font-weight:600;
        line-height:1.1;
        padding-top:4px;
      }
      .week-table thead th .day-date{
        display:block;
        margin-top:2px;
        font-size:14px;
        font-weight:400;
        line-height:1.2;
        color: var(--text-muted);
        padding-top:4px;
      }

      .week-table td.day-cell{
        background: var(--table-bg);
        height: var(--bus-row-h);
        padding:0;
        vertical-align:top;
        position:relative;
        z-index:1;
      }

      .week-table td.week-start-cell{
        position:relative;
        z-index:5;
        overflow:visible;
      }
      .week-table td.week-start-cell .row-bars{
        position:absolute;
        top:0;
        left:0;
        height:100%;
        width: 0;
        z-index:50;
        overflow:visible;
        pointer-events:auto;
      }

      .week-table td.conflict{ background: var(--conflict-bg); }
      .week-table td.bus-conflict{ box-shadow: inset 3px 0 0 var(--conflict-accent); }
      .conflict-title{ font-weight:900; color: var(--text); }

      .week-table th.day-today { box-shadow: inset 0 -2px 0 var(--primary); }
      .week-table td.day-today { background: rgba(0,122,255,0.06); }

      /* ======================================================
      trip bars
      ====================================================== */
      .trip-bar{
        position:absolute;
        z-index:200;
        box-sizing: border-box;

        height: var(--bar-h);
        padding: 2px 8px;
        overflow:hidden;

        border-radius: var(--radius);
        border: 1px solid var(--tripbar-border);
        background: var(--tripbar-bg);

        display:grid;
        grid-template-rows: repeat(4, minmax(0, 1fr));
        align-content:center;

        cursor:pointer;
        user-select:none;
        text-align:left;
        pointer-events:auto;

        transition:
          transform 140ms var(--ease),
          box-shadow 140ms var(--ease),
          background 140ms var(--ease),
          border-color 140ms var(--ease);
      }
      .trip-bar > *{
        display:flex;
        align-items:center;
        min-width: 0;
      }
      .trip-bar .bar-title{
        justify-content:center;
        text-align:center;
        font-size:12px;
        font-weight:600;
        white-space:nowrap;
        overflow:hidden;
        text-overflow:ellipsis;
      }
      .trip-bar .bar-sub{
        color: var(--text-muted);
        justify-content:center;
        text-align:center;
        font-size:10px;
        font-weight:400;
        white-space:nowrap;
        overflow:hidden;
        text-overflow:ellipsis;
      }
      .trip-bar .bar-time-row{
        justify-content:space-between;
        width:100%;
        gap:4px;
        font-variant-numeric: tabular-nums;
        font-size:12px;
        font-weight:600;
        min-height: 16px;
      }
      .trip-bar .bar-time{
        white-space:nowrap;
        overflow:hidden;
        text-overflow:ellipsis;
        flex: 0 0 auto;
        min-width: 52px;
      }
      .trip-bar .bar-drivers{
        justify-content:center;
        gap:4px;
        font-size:10px;
        letter-spacing:0.6px;
        min-height: 18px;
        padding-top: 2px;
        line-height: 1;
      }
        .trip-bar .driver{
        display: inline-flex;
        align-items: center;
        justify-content: center;

        height: 16px;              /* explicit height = perfect centering */
        padding: 0 6px;

        font-size: 10px;
        line-height: 1;
        font-weight: 500;
        letter-spacing: 0.04em;
        text-transform: uppercase;

        border-radius: 999px;
        background: color-mix(in srgb, #ffbb00 14%, transparent);
        border: 1px solid color-mix(in srgb, #ffbb00 30%, transparent);

        transform: translateY(-0.5px);
        }


      .trip-bar.cont-right{ border-top-right-radius: 0px; border-bottom-right-radius: 0px; }
      .trip-bar.cont-left{ border-top-left-radius: 0px; border-bottom-left-radius: 0px; }

      .trip-bar.unconfirmed{
        border-color: var(--neutral-bar-border);
        background: var(--neutral-bar-bg);
      }
      .trip-bar.danger{
        border-color: var(--danger-bar-border);
        background: var(--danger-bar-bg);
      }

      .trip-bar:hover{
        transform: translateY(-0.5px);
        box-shadow: 0 0 0 1px rgba(96,165,250,0.55), var(--shadow-md);
      }

      .trip-bar.cont-left::before,
        .trip-bar.cont-right::after{
            color: var(--text-strong);
            position:absolute;
            top:62%;
            transform: translateY(-50%);
            font-size: 14px;
            opacity: 1;
            pointer-events:none;
        }

        .trip-bar.cont-left::before{
            content: "◀";
            left: 6px;
        }

        .trip-bar.cont-right::after{
            content: "▶";
            right: 6px;
        }

        select.status-assigned{
        background: rgba(255,159,10,0.18);
        border-color: rgba(255,159,10,0.6);
        color: #ffe7c2;
        }

        select.status-confirmed{
        background: rgba(52,199,89,0.18);
        border-color: rgba(52,199,89,0.6);
        color: #eafff1;
        }

        .trip-bar.driverstatus-pending .driver{
        background: rgba(255,255,255,0.08);
        border-color: rgba(255,255,255,0.25);
        color: rgba(255,255,255,0.75);
        }
        .trip-bar.driverstatus-assigned .driver{
        background: rgba(255,159,10,0.18);
        border-color: rgba(255,159,10,0.6);
        color: #ffe7c2;
        }
        .trip-bar.driverstatus-confirmed .driver{
        background: rgba(52,199,89,0.18);
        border-color: rgba(52,199,89,0.6);
        color: #eafff1;
        }

        /* Prevent iOS long-press text selection/callout on trip bars */
    .trip-bar,
    .trip-bar * {
      -webkit-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
    }

      /* ======================================================
      bus assignments
      ====================================================== */
      #busPanel.is-disabled{
        pointer-events: none;
        filter: grayscale(0.15);
      }
      #busPanel.is-disabled #busGrid{
        opacity: 0.55;
        pointer-events:none;
      }

      .row-grid-4{
        display:grid;
        grid-template-columns: 110px minmax(0, 1fr) minmax(0, 1fr);
        gap:10px;
        align-items:center;
      }
      .row-grid-4.row-header{ margin-bottom: 8px; }
      .row-header-cell{ color: var(--text-secondary); white-space: nowrap; }

      /* ======================================================
      modal
      ====================================================== */
      .modal[hidden]{ display:none; }
      .modal{ position:fixed; inset:0; z-index:3000; }
      .modal-backdrop{
        position:absolute;
        inset:0;
        background: rgba(0,0,0,0.55);
        backdrop-filter: blur(6px);
      }
      .modal-card{
        position:relative;
        width: min(720px, calc(100vw - 24px));
        margin: 8vh auto 0;
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        box-shadow: var(--shadow-md);
        padding: 16px;
        max-height: calc(100vh - 6vh);
        display:flex;
        flex-direction:column;
      }
      .modal-head{
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:10px;
        margin-bottom:10px;
      }
      .modal-body{
        display:flex;
        flex-direction:column;
        flex:1 1 auto;
        overflow:hidden;
      }
      .modal-body textarea{
        flex:1 1 auto;
        min-height:240px;
        max-height:100%;
        resize:vertical;
        overflow-y:auto;
      }
      .modal-actions{
        display:flex;
        justify-content:flex-end;
        gap:10px;
        margin-top:12px;
      }

        select option {
        color: #000;
        }

        /* ======================================================
        Desktop: Taller Itinerary Modal (3x+ visual height)
        ====================================================== */

      /* Desktop only: make ONLY the itinerary modal tall */
      @media (min-width: 900px){

        #itineraryModal .modal-card{
          margin-top: 2vh;
          max-height: calc(100vh - 4vh);
        }

        #itineraryModal .modal-body{
          overflow: hidden;
        }

        #itineraryModal .modal-body textarea{
          min-height: 75vh;
          resize: none;
        }
      }

        @media (min-width: 900px){
        #itineraryModal .modal-card{
            margin: 2vh auto 0 !important;
            max-height: calc(100vh - 4vh) !important;
        }
        #itineraryModal .modal-body{
            overflow: hidden !important;
        }
        #itineraryModal #itineraryModalField{
            min-height: 75vh !important;
            resize: none !important;
        }
        }

        /* ======================================================
        Trip Details Modal – Mobile Bottom Sheet
        ====================================================== */
      @media (max-width: 900px){
        #tripDetailsModal .modal-card{
          width: min(720px, calc(100vw - 24px));
          max-width: 720px;
          margin: 0;

          position: fixed;
          left: 50%;
          top: 50%;
          transform: translate(-50%, -50%);

          border-radius: 16px;
          max-height: min(70vh, calc(100svh - 40px));
          padding: 14px;

          animation: fadeIn 180ms ease-out;
        }

        #tripDetailsModal .modal-body{
          overflow-y: auto;
        }
      }

      @keyframes fadeIn{
        from { opacity: 0; transform: translate(-50%, calc(-50% + 10px)); }
        to   { opacity: 1; transform: translate(-50%, -50%); }
      }

      /* ======================================================
      toast
      ====================================================== */
      .toast{
        position:fixed;
        top: calc(var(--topbar-h) / 2);
        left:50%;
        transform: translate(-50%, -50%);
        z-index:1000;
        padding: 6px 12px;
        border-radius: var(--radius);
        border: 1px solid var(--border);
        background: rgba(18,18,18,0.92);
        backdrop-filter: blur(10px);
        box-shadow: var(--shadow-md);
        max-width: min(90vw, 420px);
        font-size: 13px;
        font-weight: 650;
        color: var(--text-strong);
        display:flex;
        align-items:center;
        gap:8px;
      }
      .toast-icon{
        width:10px;
        height:10px;
        border-radius:999px;
        background: rgba(255,255,255,0.35);
        flex:0 0 auto;
      }
      .toast[data-variant="loading"] .toast-icon{
        width:14px;
        height:14px;
        background: transparent;
        border: 2px solid rgba(255,255,255,0.25);
        border-top-color: var(--primary);
        border-radius:999px;
        animation: spin 0.8s linear infinite;
      }
      .toast[hidden]{ display:none; }
      @keyframes spin{ to { transform: rotate(360deg); } }

      @media (max-width: 900px){
        .col-8,.col-6,.col-4,.col-3{ grid-column: span 12; }
        .subsection-grid{ grid-template-columns: 1fr; }
      }
      @media (max-width: 600px){
        :root{
          --topbar-h: 60px;
          --logo-h: 34px;
          --logo-max-w: 240px;
          --bus-col-w: 58px;
        }
        .brand-title{ font-size: var(--brand-fs-mobile); }
        .form-actions{
          flex-direction: column;
          align-items: stretch;
        }
        .form-actions > button{ width:100%; }
      }
      @media (max-width: 520px){
        .row-grid-4{ grid-template-columns: 1fr; }
        .row-grid-4.row-header{ display:none; }
      }

      /* ======================================================
        MOBILE READ-ONLY MODE
        ====================================================== */
        @media (max-width: 900px){

        /* Disable form fields */
        input,
        textarea,
        select {
            pointer-events: none;
            user-select: none;
            opacity: 0.75;
        }

        /* Allow scrolling inside textareas/modals */
        textarea {
            pointer-events: auto;
            user-select: text;
        }

        /* Allow buttons & links */
        button,
        .btn,
        .bar-info {
            pointer-events: auto;
            opacity: 1;
        }

        /* Prevent mobile keyboards from opening */
        input:focus,
        textarea:focus,
            select:focus {
                outline: none;
            }
        }

        /* Strong iOS selection/callout suppression in schedule area */
      .week-table,
      .week-table * {
        -webkit-user-select: none;
        user-select: none;
        -webkit-touch-callout: none;
      }

      /* Prevent iOS image/element drag ghost */
      .trip-bar,
      .trip-bar * {
        -webkit-user-drag: none;
      }

      /* Helps newer Safari understand gestures should not trigger selection/scroll chaining */
      .trip-bar {
        touch-action: manipulation; /* or 'none' if you don't need scrolling gestures on the bar */
      }


    </style>

  </head>

  <body>
    <div class="app">
      <header class="topbar">
        <div class="topbar-inner">
          <div class="brand">
            <div class="logo-wrap">
              <img
                src="logo.png"
                class="logo-img"
                alt="Logo"
                onerror="this.style.display='none'; this.nextElementSibling.style.display='inline-flex';"
              />
              <div class="logo-placeholder" style="display: none" aria-label="Logo placeholder">
                LOGO
              </div>
            </div>

            <h1 class="brand-title">Trip Schedule</h1>
          </div>

          <div class="top-actions">
            <label class="weekstart-toggle" title="Toggle week start day">
              <input id="weekStartToggle" type="checkbox" />
              <span>Mon start</span>
            </label>
            <button id="tripInputBtn" class="btn btn-compact" type="button">Trip Input</button>
            <button id="refreshBtn" class="btn btn-primary btn-compact" type="button">Refresh</button>
          </div>
        </div>
      </header>

      <main class="main">
        <div class="container">
          <div class="scheduler-layout" id="schedulerLayout">
            <!-- LEFT -->
            <div class="scheduler-left" id="tripScheduler">
              <div class="card compact" id="tripInfoCard">
                <div class="card-head">
                  <h2 class="section-title">Trip Information</h2>
                  <div class="card-head-actions">
                    <span id="tripIdBadge" class="badge badge-primary" style="display:none"></span>
                  </div>
                </div>

                <div class="card-content">
                  <form
                    id="tripForm"
                    class="form-grid"
                    target="hidden_iframe"
                    method="POST"
                    action="https://script.google.com/macros/s/AKfycbzW8q5o7fnpsegVgTSLgB294CCo5NWuKOWv4nZVDLFD7jmSumODVKqY5WkEcmEYaZBx/exec"
                  >
                    <input type="hidden" name="action" id="action" value="create" />
                    <input type="hidden" name="tripKey" id="tripKey" value="" />
                    <input type="hidden" name="tripId" id="tripId" value="" />

                    <div class="form-group col-6">
                      <label for="destination">Destination</label>
                      <input type="text" id="destination" name="destination" placeholder="e.g. San Antonio, TX" required />
                    </div>

                    <div class="form-group col-6">
                      <label for="customer">Customer</label>
                      <input type="text" id="customer" name="customer" placeholder="e.g. McAllen High School" required />
                    </div>

                    <div class="form-group col-6">
                      <label for="contactName">Name</label>
                      <input type="text" id="contactName" name="contactName" placeholder="e.g. Blue Escamilla" required />
                    </div>

                    <div class="form-group col-4">
                      <label for="phone">Phone</label>
                      <input type="tel" id="phone" name="phone" autocomplete="tel" inputmode="tel" placeholder="(555) 123-4567" />
                    </div>

                    <div class="form-group col-2">
                      <label for="busesNeeded">Buses</label>
                      <select id="busesNeeded" name="busesNeeded" required>
                        <option value="" disabled selected>-</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                        <option value="8">8</option>
                        <option value="9">9</option>
                        <option value="10">10</option>
                      </select>
                    </div>

                    <div class="form-group col-6">
                      <label for="tripDate">Departure Date</label>
                      <input type="date" id="tripDate" name="departureDate" required />
                    </div>

                    <div class="form-group col-6">
                      <label for="arrivalDate">Arrival Date</label>
                      <input type="date" id="arrivalDate" name="arrivalDate" />
                    </div>

                    <div class="form-group col-6">
                      <label for="departureTime">Departure Time</label>
                      <input type="time" id="departureTime" name="departureTime" />
                    </div>

                    <div class="form-group col-6">
                      <label for="arrivalTime">Arrival Time</label>
                      <input type="time" id="arrivalTime" name="arrivalTime" />
                    </div>

                    <div class="form-group col-12">
                      <label for="notes">Notes</label>
                      <textarea id="notes" name="notes" placeholder="Internal notes, reminders, billing details, special instructions…"></textarea>
                    </div>

                    <div class="subsection col-12">
                      <div class="subsection-head">
                        <h2 class="section-title">Documents</h2>
                      </div>

                      <div class="subsection-grid">
                        <div class="form-group">
                          <label for="itineraryStatus">Itinerary Status</label>
                          <select id="itineraryStatus" name="itineraryStatus" required>
                            <option value="" disabled selected>Choose…</option>
                            <option value="Pending">Pending</option>
                            <option value="Received">Received</option>
                            <option value="Not Required">Not Required</option>
                          </select>
                        </div>

                        <div class="form-group">
                          <label for="contactStatus">Contact Info Status</label>
                          <select id="contactStatus" name="contactStatus" required>
                            <option value="" disabled selected>Choose…</option>
                            <option value="Pending">Pending</option>
                            <option value="Received">Received</option>
                            <option value="Not Required">Not Required</option>
                          </select>
                        </div>

                        <div class="form-group">
                          <label for="paymentStatus">Payment Status</label>
                          <select id="paymentStatus" name="paymentStatus" required>
                            <option value="" disabled selected>Choose…</option>
                            <option value="Pending">Pending</option>
                            <option value="Signed Contract">Signed Contract</option>
                            <option value="Requisition # Received">Requisition # Received</option>
                            <option value="PO Received">PO Received</option>
                            <option value="Deposit Received">Deposit Received</option>
                            <option value="Balance Paid">Balance Paid</option>
                            <option value="Not Required">Not Required</option>
                          </select>
                        </div>

                        <div class="form-group">
                            <label for="driverStatus">Driver Status</label>
                            <select id="driverStatus" name="driverStatus" required>
                                <option value="" disabled selected>Choose…</option>
                                <option value="Pending">Pending</option>
                                <option value="Assigned">Assigned</option>
                                <option value="Confirmed">Confirmed</option>
                                <option value="Driver Info Sent">Driver Info Sent</option>
                            </select>
                        </div>
                      </div>
                    </div>

                    <textarea id="itinerary" name="itinerary" style="display:none"></textarea>

                    <div class="subsection col-12" id="busPanel">
                      <div class="subsection-head">
                        <h2 class="section-title">Bus Assignments</h2>
                      </div>

                      <div id="busPanelHint" class="help" hidden>
                        Select the number of buses above to unlock assignment fields.
                      </div>

                      <div id="busGrid"></div>
                    </div>

                    <div class="form-actions col-12">
                      <button type="submit" class="btn" id="saveBtn">Save</button>
                      <button type="button" class="btn" id="newBtn">Clear</button>
                      <button type="button" class="btn" id="deleteBtn" disabled>Delete</button>
                      <button id="itineraryBtn" type="button" class="btn btn-compact">Itinerary</button>
                    </div>
                  </form>

                  <iframe id="hidden_iframe" name="hidden_iframe" style="display:none"></iframe>
                </div>
              </div>
            </div>

            <!-- RIGHT -->
            <div class="scheduler-right">
              <div class="card">
                <div class="trip-header schedule-header">
                  <h2 class="section-title">
                    Weekly Schedule
                    <span id="overflowBadge" class="badge badge-error" style="display:none">Conflicts detected</span>
                  </h2>

                  <div class="week-controls week-controls--title">
                    <button class="btn btn-compact" id="prevWeekBtn" type="button">Prev</button>
                    <input type="date" id="weekPicker" class="weekpicker" />
                    <button class="btn btn-compact" id="nextWeekBtn" type="button">Next</button>
                  </div>
                </div>

                <div class="week-table-container in-card">
                  <table class="week-table">
                    <colgroup>
                      <col style="width: var(--bus-col-w)" />
                      <col style="width: calc((100% - var(--bus-col-w)) / 7)" />
                      <col style="width: calc((100% - var(--bus-col-w)) / 7)" />
                      <col style="width: calc((100% - var(--bus-col-w)) / 7)" />
                      <col style="width: calc((100% - var(--bus-col-w)) / 7)" />
                      <col style="width: calc((100% - var(--bus-col-w)) / 7)" />
                      <col style="width: calc((100% - var(--bus-col-w)) / 7)" />
                      <col style="width: calc((100% - var(--bus-col-w)) / 7)" />
                    </colgroup>

                    <thead>
                      <tr>
                        <th></th>
                        <th id="sun"><span class="day-name">Sunday</span><span class="day-date"></span></th>
                        <th id="mon"><span class="day-name">Monday</span><span class="day-date"></span></th>
                        <th id="tue"><span class="day-name">Tuesday</span><span class="day-date"></span></th>
                        <th id="wed"><span class="day-name">Wednesday</span><span class="day-date"></span></th>
                        <th id="thu"><span class="day-name">Thursday</span><span class="day-date"></span></th>
                        <th id="fri"><span class="day-name">Friday</span><span class="day-date"></span></th>
                        <th id="sat"><span class="day-name">Saturday</span><span class="day-date"></span></th>
                      </tr>
                    </thead>

                    <tbody id="agendaBody"></tbody>
                  </table>
                </div>

                <div id="conflictPanel" class="card" style="margin-top: 1rem; display:none">
                  <div class="card-title">
                    Conflicts
                    <span class="badge badge-error">Needs attention</span>
                  </div>
                  <div class="card-content">
                    <div id="conflictList" class="help"></div>
                  </div>
                </div>
              </div>
            </div>
            <!-- /RIGHT -->
          </div>
        </div>
      </main>
    </div>

    <!-- Global toast -->
    <div id="toast" class="toast" role="status" aria-live="polite" aria-atomic="true" hidden>
      <span class="toast-icon" aria-hidden="true"></span>
      <span id="toastText"></span>
    </div>

    <!-- Itinerary Modal -->
    <div id="itineraryModal" class="modal" hidden>
      <div class="modal-backdrop" data-close></div>

      <div class="modal-card" role="dialog" aria-modal="true">
        <div class="modal-head">
          <div class="section-title">Trip Itinerary</div>
          <button class="btn btn-compact" type="button" data-close>Close</button>
        </div>

        <div class="modal-body">
          <textarea id="itineraryModalField" placeholder="Stops, times, pickup notes..."></textarea>

          <div class="modal-actions">
            <button id="itineraryCopyBtn" class="btn btn-compact" type="button">Copy</button>
            <button id="itinerarySaveBtn" class="btn btn-primary btn-compact" type="button">Done</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Trip Details Modal (mobile-friendly tooltip replacement) -->
    <div id="tripDetailsModal" class="modal" hidden>
    <div class="modal-backdrop" data-close-details></div>

    <div class="modal-card" role="dialog" aria-modal="true">
        <div class="modal-head">
        <div class="section-title">Trip Details</div>
        <button class="btn btn-compact" type="button" data-close-details>Close</button>
        </div>

        <div class="modal-body" style="overflow:auto; padding-right:6px;">
        <div id="tripDetailsBody" class="help" style="white-space: pre-wrap; font-size: 13px; color: rgba(255,255,255,0.88); line-height: 1.35;"></div>
        </div>
    </div>
    </div>

    <script>
    // ======================================================
    // CONFIG (single-file)
    // ======================================================
    const CONFIG = {
        ENDPOINT:
        "https://script.google.com/macros/s/AKfycbzW8q5o7fnpsegVgTSLgB294CCo5NWuKOWv4nZVDLFD7jmSumODVKqY5WkEcmEYaZBx/exec",
        BUS_LANES: ["218", "763", "470", "133", "506", "746", "607", "897", "898", "474"],
        MONTHS: ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"],
        JSONP_TIMEOUT: 20000,
    };

    // ======================================================
    // DOM
    // ======================================================
    const $ = (id) => document.getElementById(id);

    const dom = {
        toast: $("toast"),
        toastText: $("toastText"),

        weekPicker: $("weekPicker"),
        weekStartToggle: $("weekStartToggle"),

        tripForm: $("tripForm"),
        hiddenIframe: $("hidden_iframe"),

        action: $("action"),
        tripKey: $("tripKey"),
        tripId: $("tripId"),
        tripIdBadge: $("tripIdBadge"),

        saveBtn: $("saveBtn"),
        deleteBtn: $("deleteBtn"),
        newBtn: $("newBtn"),

        itineraryBtn: $("itineraryBtn"),
        itineraryModal: $("itineraryModal"),
        itineraryField: $("itinerary"),
        itineraryModalField: $("itineraryModalField"),
        itineraryCopyBtn: $("itineraryCopyBtn"),
        itinerarySaveBtn: $("itinerarySaveBtn"),

        busesNeeded: $("busesNeeded"),
        busGrid: $("busGrid"),
        busPanel: $("busPanel"),
        busPanelHint: $("busPanelHint"),

        agendaBody: $("agendaBody"),

        refreshBtn: $("refreshBtn"),
        tripInputBtn: $("tripInputBtn"),
        schedulerLayout: $("schedulerLayout"),
        tripScheduler: $("tripScheduler"),

        prevWeekBtn: $("prevWeekBtn"),
        nextWeekBtn: $("nextWeekBtn"),

        conflictPanel: $("conflictPanel"),
        conflictList: $("conflictList"),
        conflictBadge: $("overflowBadge"),

        tripDetailsModal: $("tripDetailsModal"),
        tripDetailsBody: $("tripDetailsBody"),

    };

    // ======================================================
    // STATE
    // ======================================================
    const state = {
        currentDate: new Date(),
        weekStartsOnMonday: false,

        busesList: [],
        driversList: [],
        busRows: [],

        trips: [],
        assignmentsByTripKey: {},
        tripByKey: {},
        busRowIndex: new Map(),

        pendingWrite: null,
        verifyFallbackTimer: null,
        toastTimer: null,
    };

    // ======================================================
    // Helpers
    // ======================================================

// iOS: prevent text selection from schedule grid & trip bars
document.addEventListener(
  "selectstart",
  (e) => {
    // Allow selection inside modals and textareas
    if (e.target.closest("#itineraryModal, #tripDetailsModal, textarea")) return;

    // Block selection in schedule grid / trip bars
    if (e.target.closest(".week-table, .trip-bar")) {
      e.preventDefault();
    }
  },
  { passive: false }
);

function enableMobileLongPress(bar, detailsText) {
  let timer = null;
  let startX = 0, startY = 0;

  bar.addEventListener("contextmenu", (e) => e.preventDefault());

  bar.addEventListener(
    "touchstart",
    (e) => {
      const t = e.touches[0];
      startX = t.clientX;
      startY = t.clientY;

      e.preventDefault(); // block iOS selection/callout
      timer = setTimeout(() => {
        openTripDetailsModal(detailsText);
        timer = null;
      }, 450);
    },
    { passive: false }
  );

  bar.addEventListener(
    "touchmove",
    (e) => {
      if (!timer) return;

      const t = e.touches[0];
      const dx = Math.abs(t.clientX - startX);
      const dy = Math.abs(t.clientY - startY);

      if (dx > 8 || dy > 8) {
        clearTimeout(timer);
        timer = null;
        return;
      }

      e.preventDefault(); // keep iOS from highlighting while waiting
    },
    { passive: false }
  );

  bar.addEventListener("touchend", () => {
    if (timer) clearTimeout(timer);
    timer = null;
  });
}

    const delay = (ms) => new Promise((r) => setTimeout(r, ms));

    function debounce(fn, wait = 120) {
        let t = null;
        return (...args) => {
        if (t) clearTimeout(t);
        t = setTimeout(() => fn(...args), wait);
        };
    }

    /**
     * Reflow bars after layout settles (sticky header, scrollbars, fonts, flex/grid).
     * Uses 2x rAF so measurements are stable before positioning bars.
     */
    function rerenderAgendaAfterLayout() {
        requestAnimationFrame(() => requestAnimationFrame(() => renderAgenda()));
    }

    /**
     * Single debounced reflow scheduler used everywhere (resize, observers, toggles).
     */
    const scheduleAgendaReflow = debounce(() => {
        rerenderAgendaAfterLayout();
    }, 120);

    function safeUUID() {
        try {
        return crypto.randomUUID();
        } catch {}
        return `tk_${Date.now()}_${Math.floor(Math.random() * 1e9)}`;
    }

    function escHtml(s) {
        return String(s ?? "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    function clipText(s, n = 240) {
        const t = String(s || "").trim();
        return !t ? "" : t.length > n ? t.slice(0, n).trimEnd() + "…" : t;
    }

    function makeCb(prefix) {
        return `${prefix}_${Date.now()}_${Math.floor(Math.random() * 1e6)}`;
    }

    function withCacheBust(url) {
      const bust = `_=${Date.now()}`;
      return url.includes("?") ? `${url}&${bust}` : `${url}?${bust}`;
    }

    function jsonp(url, callbackName, timeoutMs = CONFIG.JSONP_TIMEOUT) {
      return new Promise((resolve, reject) => {
        const script = document.createElement("script");
        const cb = callbackName;
        let settled = false;

        const timer = setTimeout(() => {
          settled = true;
          cleanup(false);
          reject(new Error("JSONP timeout: " + url));
        }, timeoutMs);

        function cleanup(removeCb) {
          clearTimeout(timer);
          if (removeCb) {
            try { delete window[cb]; } catch {}
          }
          script?.parentNode?.removeChild(script);
        }

        window[cb] = (data) => {
          if (settled) return;
          settled = true;
          cleanup(true);
          resolve(data);
        };

        script.onerror = () => {
          if (settled) return;
          settled = true;
          cleanup(true);
          reject(new Error("JSONP load error: " + url));
        };

        // ✅ cache-busted JSONP request
        script.src = withCacheBust(url);
        document.body.appendChild(script);
      });
    }

    const api = {
        listDrivers(activeOnly = true) {
        const cb = makeCb("cbDrivers");
        return jsonp(
            `${CONFIG.ENDPOINT}?fn=listDrivers&activeOnly=${activeOnly ? "true" : "false"}&callback=${cb}`,
            cb
        );
        },
        listBuses(activeOnly = true) {
        const cb = makeCb("cbBuses");
        return jsonp(
            `${CONFIG.ENDPOINT}?fn=listBuses&activeOnly=${activeOnly ? "true" : "false"}&callback=${cb}`,
            cb
        );
        },
        weekData(start, end) {
        const cb = makeCb("cbWeek");
        return jsonp(
            `${CONFIG.ENDPOINT}?fn=weekData&start=${encodeURIComponent(start)}&end=${encodeURIComponent(
            end
            )}&callback=${cb}`,
            cb
        );
        },
        getTrip(tripKey) {
        const cb = makeCb("cbTrip");
        return jsonp(`${CONFIG.ENDPOINT}?fn=getTrip&tripKey=${encodeURIComponent(tripKey)}&callback=${cb}`, cb);
        },
        getBusAssignments(tripKey) {
        const cb = makeCb("cbAssign");
        return jsonp(
            `${CONFIG.ENDPOINT}?fn=getBusAssignments&tripKey=${encodeURIComponent(tripKey)}&callback=${cb}`,
            cb
        );
        },
    };

    function normalizeTime(t) {
        if (!t) return "";
        if (t instanceof Date && !isNaN(t.getTime())) {
        return `${String(t.getHours()).padStart(2, "0")}:${String(t.getMinutes()).padStart(2, "0")}`;
        }
        const s = String(t).trim();
        if (/^\d{2}:\d{2}$/.test(s)) return s;

        const m = s.match(/^(\d{1,2}):(\d{2})\s*([AaPp][Mm])$/);
        if (m) {
        let hh = Number(m[1]);
        const mm = Number(m[2]);
        const ap = m[3].toLowerCase();
        if (ap === "pm" && hh !== 12) hh += 12;
        if (ap === "am" && hh === 12) hh = 0;
        return `${String(hh).padStart(2, "0")}:${String(mm).padStart(2, "0")}`;
        }

        if (/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}/.test(s)) {
        const mIso = s.match(/T(\d{2}):(\d{2})/);
        if (mIso) return `${mIso[1]}:${mIso[2]}`;
        }

        const d2 = new Date(s);
        if (!isNaN(d2.getTime())) {
        return `${String(d2.getHours()).padStart(2, "0")}:${String(d2.getMinutes()).padStart(2, "0")}`;
        }
        return "";
    }

    function formatTime12(timeValue) {
        const hhmm = normalizeTime(timeValue);
        if (!hhmm) return "";
        let [hh, mm] = hhmm.split(":").map(Number);
        const ampm = hh >= 12 ? "PM" : "AM";
        hh = hh % 12;
        if (hh === 0) hh = 12;
        return `${hh}:${String(mm).padStart(2, "0")} ${ampm}`;
    }

    // Force-refresh "is-empty" styling after programmatic value changes
    function refreshEmptyStateUI() {
        const ids = [
            "destination",
            "customer",
            "contactName",
            "phone",
            "tripDate",
            "arrivalDate",
            "departureTime",
            "arrivalTime",
            "busesNeeded",
            "itineraryStatus",
            "contactStatus",
            "paymentStatus",
            "driverStatus",
            "itinerary",
            "notes",
        ];

        for (const id of ids) {
            const el = document.getElementById(id);
            if (!el) continue;

            const v = el.value ?? "";
            const empty = el.tagName === "TEXTAREA" ? !String(v).trim() : !String(v);

            el.classList.toggle("is-empty", empty);
        }
    }

    // ======================================================
    // Toast
    // ======================================================
    function toast(message, variant = "info", duration = 1400) {
        if (!dom.toast || !dom.toastText) return;
        dom.toast.dataset.variant = variant;
        dom.toastText.textContent = message;
        dom.toast.hidden = false;

        if (state.toastTimer) clearTimeout(state.toastTimer);
        state.toastTimer = setTimeout(() => (dom.toast.hidden = true), duration);
    }

    function toastShow(message, variant = "info") {
        if (!dom.toast || !dom.toastText) return;
        dom.toast.dataset.variant = variant;
        dom.toastText.textContent = message;
        dom.toast.hidden = false;
        if (state.toastTimer) clearTimeout(state.toastTimer);
        state.toastTimer = null;
    }

    function toastHide(delayMs = 0) {
        if (!dom.toast) return;
        if (state.toastTimer) clearTimeout(state.toastTimer);
        if (delayMs > 0) state.toastTimer = setTimeout(() => (dom.toast.hidden = true), delayMs);
        else dom.toast.hidden = true;
    }

    // ======================================================
    // Status select coloring
    // ======================================================
    function updateStatusSelect(el) {
    if (!el) return;

    const id = el.id;
    const v = String(el.value || "").trim().toLowerCase();

    el.classList.remove(
        "status-pending",
        "status-ok",
        "status-assigned",
        "status-confirmed"
    );

    if (!v) return;

    // DRIVER STATUS (custom logic)
        if (id === "driverStatus") {
            if (v === "pending") {
            el.classList.add("status-pending");        // grey
            } else if (v === "assigned") {
            el.classList.add("status-assigned");       // yellow
            } else {
            el.classList.add("status-confirmed");      // green
            }
            return;
        }

    // ALL OTHER DOCUMENT STATUSES
    // Pending = RED, anything else = GREEN
        if (v === "pending") {
            el.classList.add("status-pending");          // red
        } else {
            el.classList.add("status-ok");               // green
        }
    }

    function setSelectToPlaceholder(id) {
        const el = $(id);
        if (!el) return;
        el.selectedIndex = 0;
        el.dispatchEvent(new Event("change", { bubbles: true }));
    }

    // ======================================================
    // Week controls
    // ======================================================
    function getDayIds() {
        return state.weekStartsOnMonday
        ? ["mon", "tue", "wed", "thu", "fri", "sat", "sun"]
        : ["sun", "mon", "tue", "wed", "thu", "fri", "sat"];
    }

    function toLocalDateInputValue(d) {
        const pad = (n) => String(n).padStart(2, "0");
        return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}`;
    }

    function addDays(d, n) {
        const x = new Date(d);
        x.setDate(x.getDate() + n);
        return x;
    }

    function ymd(d) {
        const pad = (n) => String(n).padStart(2, "0");
        return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}`;
    }

    function startOfWeek(d) {
        const date = new Date(d.getFullYear(), d.getMonth(), d.getDate());
        const day = date.getDay();

        if (!state.weekStartsOnMonday) {
        date.setDate(date.getDate() - day);
        return date;
        }
        const diff = (day + 6) % 7;
        date.setDate(date.getDate() - diff);
        return date;
    }

    function setHeaderOrder() {
        const theadRow = document.querySelector(".week-table thead tr");
        if (!theadRow) return;

        const cells = Array.from(theadRow.children);
        const corner = cells[0];
        const byId = {};
        for (const th of cells.slice(1)) if (th.id) byId[th.id] = th;

        while (theadRow.firstChild) theadRow.removeChild(theadRow.firstChild);
        theadRow.appendChild(corner);
        for (const id of getDayIds()) if (byId[id]) theadRow.appendChild(byId[id]);
    }

    function getWeekRange() {
        return { start: ymd(state.currentDate), end: ymd(addDays(state.currentDate, 6)) };
    }

    function buildAgendaRows() {
        if (!dom.agendaBody) return;

        dom.agendaBody.innerHTML = "";
        state.busRowIndex = new Map();

        const dayIds = getDayIds(); // build body in same order as header

        CONFIG.BUS_LANES.forEach((busId, idx) => {
        state.busRowIndex.set(String(busId), idx);

        const tr = document.createElement("tr");

        // sticky bus label column
        const tdBus = document.createElement("td");
        tdBus.textContent = busId;
        tr.appendChild(tdBus);

        // build 7 day cells in current visual order
        for (let i = 0; i < 7; i++) {
            const td = document.createElement("td");
            td.className = "day-cell";
            td.dataset.dayId = dayIds[i];
            tr.appendChild(td);
        }

        // first visual day column is always the week-start cell
        tr.cells[1].classList.add("week-start-cell");

        const bars = document.createElement("div");
        bars.className = "row-bars";
        tr.cells[1].appendChild(bars);

        dom.agendaBody.appendChild(tr);
        });
    }

    function ensureAgendaGrid() {
        if (!dom.agendaBody) return false;
        const expected = CONFIG.BUS_LANES.length;
        const ok = dom.agendaBody.rows && dom.agendaBody.rows.length === expected;
        if (!ok) buildAgendaRows();
        return dom.agendaBody.rows && dom.agendaBody.rows.length === expected;
    }

    function updateWeekDates() {
        const selected = dom.weekPicker?.value ? new Date(dom.weekPicker.value + "T00:00:00") : new Date();

        state.currentDate = startOfWeek(selected);

        const today = new Date();
        const todayYmd = ymd(today);
        const ids = getDayIds();

        ids.forEach((dayId, index) => {
        const date = addDays(state.currentDate, index);
        const th = document.getElementById(dayId);
        const dateSpan = th?.querySelector?.(".day-date");
        if (dateSpan) dateSpan.textContent = `${CONFIG.MONTHS[date.getMonth()]} ${date.getDate()}`;
        th?.classList.toggle("day-today", ymd(date) === todayYmd);
        });

        if (dom.agendaBody?.rows?.length) {
        for (let r = 0; r < dom.agendaBody.rows.length; r++) {
            const row = dom.agendaBody.rows[r];
            for (let c = 1; c <= 7; c++) {
            const cell = row.cells[c];
            if (!cell) continue;

            const dayId = cell.dataset.dayId; // "mon"..."sun"
            const dayIndex = getDayIds().indexOf(dayId);
            const d = addDays(state.currentDate, dayIndex);

            cell.classList.toggle("day-today", ymd(d) === todayYmd);
            }
        }
        }

        refreshWeekData();
    }

    function changeWeek(direction) {
        const selected = dom.weekPicker?.value ? new Date(dom.weekPicker.value + "T00:00:00") : new Date();
        const moved = addDays(selected, direction * 7);
        if (dom.weekPicker) dom.weekPicker.value = toLocalDateInputValue(moved);
        state.currentDate = startOfWeek(moved);
        updateWeekDates();
    }

    // ======================================================
    // Trip mode + badge
    // ======================================================
    function setTripIdBadge(text, show = true) {
        if (!dom.tripIdBadge) return;
        dom.tripIdBadge.textContent = text;
        dom.tripIdBadge.style.display = show ? "inline-block" : "none";
    }

    function setModeNew() {
        dom.action.value = "create";
        dom.tripKey.value = "";
        dom.tripId.value = "";
        setTripIdBadge("", false);
        dom.deleteBtn.disabled = true;
    }

    function setModeEdit(tripKey, tripId) {
        dom.action.value = "update";
        dom.tripKey.value = tripKey;
        dom.tripId.value = tripId || "";
        setTripIdBadge(tripId || "", !!tripId);
        dom.deleteBtn.disabled = false;
    }

    // ======================================================
    // Itinerary modal
    // ======================================================
    function openItineraryModal() {
        dom.itineraryModalField.value = dom.itineraryField.value || "";
        dom.itineraryModal.hidden = false;
        dom.itineraryModalField.focus();
    }

    function closeItineraryModal() {
        dom.itineraryField.value = dom.itineraryModalField.value || "";
        dom.itineraryField.dispatchEvent(new Event("input", { bubbles: true }));
        dom.itineraryModal.hidden = true;
    }

    function openTripDetailsModal(text) {
    dom.tripDetailsBody.textContent = text || "";
    dom.tripDetailsModal.hidden = false;
    }

    function closeTripDetailsModal() {
    dom.tripDetailsModal.hidden = true;
    }

    // close handlers
    (function wireTripDetailsModalClose() {
    const m = document.getElementById("tripDetailsModal");
    if (!m) return;

    m.addEventListener("click", (e) => {
        if (e.target && e.target.dataset && e.target.dataset.closeDetails !== undefined) {
        closeTripDetailsModal();
        }
    });

    document.addEventListener("keydown", (e) => {
        if (!m.hidden && e.key === "Escape") closeTripDetailsModal();
    });
    })();


    // ======================================================
    // Bus assignments UI
    // ======================================================
    function makeSelect(name) {
        const sel = document.createElement("select");
        sel.name = name;
        return sel;
    }

    function setSelectOptions(sel, options, selectedValue) {
        const prev = selectedValue ?? sel.value;
        sel.innerHTML = "";
        for (const o of options) {
        const opt = document.createElement("option");
        opt.value = o.value;
        opt.textContent = o.label;
        sel.appendChild(opt);
        }
        const has = options.some((o) => String(o.value) === String(prev));
        sel.value = has ? String(prev) : "None";
    }

    function getBusOptions() {
        const base = [{ value: "None", label: "None" }];
        const mapped = state.busesList.map((b) => ({
        value: String(b.busId),
        label: b.busName ? `${b.busName}` : `Bus ${b.busId}`,
        }));
        return base.concat(mapped);
    }

    function getDriverOptions() {
        const base = [{ value: "None", label: "None" }];
        const mapped = state.driversList.map((d) => ({
        value: d.driverName ? String(d.driverName) : String(d.driverId),
        label: d.driverName ? String(d.driverName) : String(d.driverId),
        }));
        return base.concat(mapped);
    }

    function syncBusSelectEmptyState() {
        document.querySelectorAll("#busGrid select").forEach((el) => {
        const v = (el.value ?? "").trim();
        el.classList.toggle("is-empty", !v || v === "None");
        });
    }

    function refreshBusSelectOptions() {
        const busOpts = getBusOptions();
        const drvOpts = getDriverOptions();
        state.busRows.forEach((r) => {
        setSelectOptions(r.busSel, busOpts);
        setSelectOptions(r.d1Sel, drvOpts);
        setSelectOptions(r.d2Sel, drvOpts);
        });
        syncBusSelectEmptyState();
    }

    function updateBusRowVisibility() {
        const raw = Number(dom.busesNeeded.value);
        const n = raw > 0 ? Math.min(10, raw) : 1;

        state.busRows.forEach((r, idx) => {
        const show = idx < n;
        r.row.style.display = show ? "grid" : "none";

        const enabled = raw > 0 && show;
        r.busSel.disabled = !enabled;
        r.d1Sel.disabled = !enabled;
        r.d2Sel.disabled = !enabled;

        if (!show) {
            r.busSel.value = "None";
            r.d1Sel.value = "None";
            r.d2Sel.value = "None";
        }
        });

        syncBusSelectEmptyState();
    }

    function syncBusPanelState() {
        const unlocked = Number(dom.busesNeeded.value) > 0;
        dom.busPanel.classList.toggle("is-disabled", !unlocked);
        dom.busPanelHint.hidden = unlocked;
    }

    function setBusesNeededAndSync(value) {
        dom.busesNeeded.value = value;
        updateBusRowVisibility();
        syncBusPanelState();
    }

    function buildBusRowsOnce() {
        dom.busGrid.innerHTML = "";
        state.busRows.length = 0;

        const header = document.createElement("div");
        header.className = "row-grid-4 row-header";

        const h1 = document.createElement("label");
        h1.className = "row-header-cell";
        h1.textContent = "Bus";

        const h2 = document.createElement("label");
        h2.className = "row-header-cell";
        h2.textContent = "Driver 1";

        const h3 = document.createElement("label");
        h3.className = "row-header-cell";
        h3.textContent = "Driver 2";

        header.append(h1, h2, h3);
        dom.busGrid.appendChild(header);

        for (let i = 1; i <= 10; i++) {
        const row = document.createElement("div");
        row.className = "row-grid-4";

        const busSel = makeSelect(`bus${i}`);
        const d1Sel = makeSelect(`bus${i}_driver1`);
        const d2Sel = makeSelect(`bus${i}_driver2`);

        row.appendChild(busSel);
        row.appendChild(d1Sel);
        row.appendChild(d2Sel);

        dom.busGrid.appendChild(row);
        state.busRows.push({ row, busSel, d1Sel, d2Sel });
        }

        refreshBusSelectOptions();
        updateBusRowVisibility();
        syncBusSelectEmptyState();

        refreshEmptyStateUI(); // PATCH: remove stale muted styling
    }

    // ======================================================
    // Agenda rendering (same logic, compact)
    // ======================================================
    function parseYMD(s) {
        if (!s) return null;
        const iso = String(s).trim().slice(0, 10);
        if (/^\d{4}-\d{2}-\d{2}$/.test(iso)) {
        const [y, m, d] = iso.split("-").map(Number);
        return new Date(y, m - 1, d);
        }
        const d = new Date(s);
        return isNaN(d.getTime()) ? null : new Date(d.getFullYear(), d.getMonth(), d.getDate());
    }

    function clearAgenda() {
        dom.agendaBody?.querySelectorAll(".row-bars").forEach((b) => (b.innerHTML = ""));
    }

    function clearConflictStyles() {
        if (!dom.agendaBody) return;
        for (let r = 0; r < dom.agendaBody.rows.length; r++) {
        const row = dom.agendaBody.rows[r];
        row.cells[0]?.classList?.remove("bus-conflict");
        for (let c = 1; c <= 7; c++) row.cells[c]?.classList?.remove("conflict");
        }
    }

    function showConflictsPanel(conflicts) {
        if (!conflicts || conflicts.length === 0) {
        dom.conflictPanel.style.display = "none";
        dom.conflictList.innerHTML = "";
        return;
        }

        dom.conflictPanel.style.display = "block";

        const html = conflicts
        .map((c, idx) => {
            const when = escHtml(c.dayLabel);
            const bus = escHtml(c.busId);

            const tripsHtml = c.items
            .map((it) => {
                const t = it.trip || {};
                const title = escHtml(t.destination || "Trip");
                const cust = escHtml(t.customer || "");
                const d1 = escHtml(it.driver1 || "—");
                const d2 = escHtml(it.driver2 || "—");
                const tripKey = escHtml(String(it.tripKey || ""));

                return `
                <div class="trip-chip conflict-indicator" data-tripkey="${tripKey}" style="margin-top:10px;" role="button" tabindex="0">
                    <div class="title">⚠ ${title}</div>
                    <div class="meta">${cust}${cust ? " • " : ""}Bus ${bus} • ${d1}${d2 && d2 !== "—" ? " / " + d2 : ""}</div>
                </div>
                `;
            })
            .join("");

            return `
            <div style="margin-top:${idx === 0 ? 0 : 14}px;">
                <div class="conflict-title">Bus ${bus} — ${when}</div>
                <div class="help">${c.items.length} trip(s) overlap</div>
                ${tripsHtml}
            </div>
            `;
        })
        .join("");

        dom.conflictList.innerHTML = html;

        dom.conflictList.querySelectorAll("[data-tripkey]").forEach((el) => {
        const open = () => openTripForEdit(el.dataset.tripkey);
        el.addEventListener("click", open);
        el.addEventListener("keydown", (e) => {
            if (e.key === "Enter" || e.key === " ") {
            e.preventDefault();
            open();
            }
        });
        });
    }

    function getWeekDates() {
        const out = [];
        for (let i = 0; i < 7; i++) out.push(ymd(addDays(state.currentDate, i)));
        return out;
    }

    // Stable metrics for positioning bars
    function getDayColumnMetricsRelativeToRows() {
    const firstBodyRow = dom.agendaBody?.rows?.[0];
    if (!firstBodyRow || firstBodyRow.cells.length < 8) return null;

    const startCell = firstBodyRow.cells[1];

    // Use rect-based measurements consistently (same coordinate system).
    const baseRect = startCell.getBoundingClientRect();

    const starts = [];
    const widths = [];

        for (let i = 1; i <= 7; i++) {
            const cell = firstBodyRow.cells[i];
            if (!cell) continue;

            const r = cell.getBoundingClientRect();
            starts.push(r.left - baseRect.left);
            widths.push(r.width);
        }

        return { starts, widths };
    }


    // Ensure each .row-bars overlay matches the exact measured width of the 7 day columns.
    // This prevents bars from being positioned outside the overlay (invisible/clipped),
    // especially when the table is scrollable or min-width kicks in.
    function syncRowBarsWidth(col) {
        if (!col || !dom.agendaBody) return;
        const total = col.widths.reduce((a, b) => a + (b || 0), 0);

        dom.agendaBody.querySelectorAll(".row-bars").forEach((bars) => {
            bars.style.width = `${total}px`;
        });
    }


         // Single (ONLY) implementation: clamps right edge to prevent 1px bleed
        function positionBarWithinOverlay(bar, bars, col, startIdx, endIdx) {
        const inset = 6;

        // start position from measured column starts
        const leftPx = (col.starts[startIdx] ?? 0) + inset;

        // width = sum of measured column widths across span
        let spanW = 0;
        for (let i = startIdx; i <= endIdx; i++) spanW += col.widths[i] ?? 0;

        // subtract inset on both sides
        let widthPx = Math.max(0, spanW - inset * 2);

        // hard clamp to the exact measured total width of all 7 columns
        const max = Math.max(0, col.widths.reduce((a, b) => a + (b || 0), 0));

        // 1px safety so we never cross the last grid line
        const EPS = 1;

        if (leftPx >= max) {
            bar.style.left = `${max}px`;
            bar.style.width = `0px`;
            return;
        }

        widthPx = Math.max(0, Math.min(widthPx, max - leftPx - EPS));

        bar.style.left = `${leftPx}px`;
        bar.style.width = `${widthPx}px`;
        }

    function renderAgenda() {
        if (!ensureAgendaGrid()) return;

        clearConflictStyles();
        showConflictsPanel([]);
        clearAgenda();
        dom.conflictBadge.style.display = "none";

        const week = getWeekDates();
        const weekStart = week[0];
        const weekEnd = week[6];

        const col = getDayColumnMetricsRelativeToRows();
        if (!col) return;

        // PATCH: match overlays to the real measured width
        syncRowBarsWidth(col);


        const cellCounts = {};
        const cellItems = {};

        const visibleTrips = state.trips
        .map((t) => {
            const dep = parseYMD(t.departureDate);
            const arr = parseYMD(t.arrivalDate) || dep;
            return { ...t, _dep: dep, _arr: arr };
        })
        .filter((t) => t._dep && t._arr)
        .filter((t) => !(ymd(t._arr) < weekStart || ymd(t._dep) > weekEnd));

        // conflict scan
        for (const t of visibleTrips) {
        const depY = ymd(t._dep);
        const arrY = ymd(t._arr);

        const start = depY < weekStart ? weekStart : depY;
        const end = arrY > weekEnd ? weekEnd : arrY;

        const startIdx = week.indexOf(start);
        const endIdx = week.indexOf(end);
        if (startIdx === -1 || endIdx === -1) continue;

        const assigns = state.assignmentsByTripKey[String(t.tripKey)] || [];
        for (const a of assigns) {
            const busId = String(a.busId || "").trim();
            if (state.busRowIndex.get(busId) === undefined) continue;

            for (let d = startIdx; d <= endIdx; d++) {
            const key = `${busId}|${d}`;
            cellCounts[key] = (cellCounts[key] || 0) + 1;
            (cellItems[key] ||= []).push({
                tripKey: t.tripKey,
                driver1: a.driver1 && a.driver1 !== "None" ? a.driver1 : "—",
                driver2: a.driver2 && a.driver2 !== "None" ? a.driver2 : "—",
                trip: t,
            });
            }
        }
        }

        // mark conflicts
        const conflicts = [];
        for (const k of Object.keys(cellCounts)) {
        if (cellCounts[k] <= 1) continue;
        const [busId, dayIdxStr] = k.split("|");
        const dayIdx = Number(dayIdxStr);

        const rowIdx = state.busRowIndex.get(busId);
        const row = dom.agendaBody.rows[rowIdx];
        if (!row) continue;

        row.cells[0].classList.add("bus-conflict");
        row.cells[dayIdx + 1]?.classList.add("conflict");

        const dateObj = addDays(state.currentDate, dayIdx);
        conflicts.push({
            busId,
            dayLabel: `${CONFIG.MONTHS[dateObj.getMonth()]} ${dateObj.getDate()}`,
            items: cellItems[k] || [],
        });
        }

        showConflictsPanel(conflicts);
        dom.conflictBadge.style.display = conflicts.length ? "inline-block" : "none";

        // lane packing
        const lanesByBus = {};
        function allocateLane(busId, startIdx, endIdx) {
        (lanesByBus[busId] ||= []);
        const lanes = lanesByBus[busId];

        for (let li = 0; li < lanes.length; li++) {
            const occ = lanes[li];
            let ok = true;
            for (let d = startIdx; d <= endIdx; d++)
            if (occ[d]) {
                ok = false;
                break;
            }
            if (ok) {
            for (let d = startIdx; d <= endIdx; d++) occ[d] = true;
            return li;
            }
        }

        const newOcc = Array(7).fill(false);
        for (let d = startIdx; d <= endIdx; d++) newOcc[d] = true;
        lanes.push(newOcc);
        return lanes.length - 1;
        }

        // render bars
        for (const t of visibleTrips) {
        const depY = ymd(t._dep);
        const arrY = ymd(t._arr);

        const start = depY < weekStart ? weekStart : depY;
        const end = arrY > weekEnd ? weekEnd : arrY;

        const startIdx = week.indexOf(start);
        const endIdx = week.indexOf(end);
        if (startIdx === -1 || endIdx === -1) continue;

        const assigns = state.assignmentsByTripKey[String(t.tripKey)] || [];
        if (!assigns.length) continue;

        const continuesLeft = depY < weekStart;
        const continuesRight = arrY > weekEnd;

        for (const a of assigns) {
            const busId = String(a.busId || "").trim();
            const rowIdx = state.busRowIndex.get(busId);
            if (rowIdx === undefined) {
                console.warn("Unknown busId in assignment:", busId, "known:", [...state.busRowIndex.keys()]);
                continue;
            }

            const row = dom.agendaBody.rows[rowIdx];
            const bars = row?.querySelector?.(".row-bars");
            if (!bars) continue;

            const lane = allocateLane(busId, startIdx, endIdx);

            const bar = document.createElement("div");
            bar.className = "trip-bar";
            if (continuesLeft) bar.classList.add("cont-left");
            if (continuesRight) bar.classList.add("cont-right");

            const pay = String(t.paymentStatus || "").toLowerCase();
            if (pay === "pending") bar.classList.add("unconfirmed");

            const ds = String(t.driverStatus || "").trim().toLowerCase();
            if (ds === "pending") bar.classList.add("driverstatus-pending");
            else if (ds === "assigned") bar.classList.add("driverstatus-assigned");
            else if (ds === "confirmed" || ds === "driver info sent")
                bar.classList.add("driverstatus-confirmed");


            // conflict touch?
            let touchesConflict = false;
            for (let d = startIdx; d <= endIdx; d++) {
            const key = `${busId}|${d}`;
            if ((cellCounts[key] || 0) > 1) {
                touchesConflict = true;
                break;
            }
            }
            if (touchesConflict) bar.classList.add("danger");

            const dest = t.destination || "Trip";
            const cust = t.customer || "";

            const d1 = a.driver1 && a.driver1 !== "None" ? a.driver1 : "—";
            const d2 = a.driver2 && a.driver2 !== "None" ? a.driver2 : "—";

            const depTime = t.departureTime;
            const arrTime = t.arrivalTime;

            const isActualSingleDay = depY === arrY;
            const showDep = isActualSingleDay ? !!depTime : start === depY && !!depTime;
            const showArr = isActualSingleDay ? !!arrTime : end === arrY && !!arrTime;

            const line1 = document.createElement("div");
            line1.className = "bar-title";
            line1.textContent = dest;

            const line2 = document.createElement("div");
            line2.className = "bar-sub";
            line2.textContent = cust;

            const timeRow = document.createElement("div");
            timeRow.className = "bar-time-row";

            const left = document.createElement("span");
            left.className = "bar-time left";
            left.textContent = showDep ? formatTime12(depTime) : "";

            const right = document.createElement("span");
            right.className = "bar-time right";
            right.textContent = showArr ? formatTime12(arrTime) : "";

            timeRow.append(left, right);

            const line4 = document.createElement("div");
            line4.className = "bar-sub bar-drivers";
            line4.innerHTML = `
            <span class="driver">${escHtml(d1)}</span>
            ${d2 && d2 !== "—" ? `<span class="driver">${escHtml(d2)}</span>` : ""}
            `;

            bar.append(line1, line2, timeRow, line4);

            positionBarWithinOverlay(bar, bars, col, startIdx, endIdx);

            const rootCss = getComputedStyle(document.documentElement);
            const barH = parseFloat(rootCss.getPropertyValue("--bar-h")) || 46;
            const step = parseFloat(rootCss.getPropertyValue("--bar-lane-step")) || 52;
            bar.style.top = `calc(50% - ${barH / 2}px + ${lane * step}px)`;

const name = t.contactName || "";
const phone = t.phone || "";

const itin = clipText(t.itinerary, 400);
const notes = clipText(t.notes, 300);

bar.title =
  `Destination\n${dest}\n\n` +
  `Customer\n${cust}\n\n` +
  `Name Phone\n${name}${phone ? " " + phone : ""}` +
  (itin ? `\n\nItinerary\n${itin}` : "") +
  (notes ? `\n\nNotes\n${notes}` : "");

            const detailsText = bar.title || "";

            // Desktop / normal tap → edit
            bar.addEventListener("click", () => openTripForEdit(t.tripKey));

            // Mobile long-press → details
            enableMobileLongPress(bar, detailsText);

            bar.setAttribute("role", "button");
            bar.setAttribute("tabindex", "0");
            bar.addEventListener("keydown", (e) => {
            if (e.key === "Enter" || e.key === " ") {
                e.preventDefault();
                openTripForEdit(t.tripKey);
            }
            });

            bars.appendChild(bar);
            bar.dataset.details = bar.title;
        }
        }
    }

    // ======================================================
    // Data loading
    // ======================================================
    async function loadDriversAndBuses() {
        const [driversResp, busesResp] = await Promise.all([api.listDrivers(true), api.listBuses(true)]);
        state.driversList = driversResp?.ok && driversResp.drivers ? driversResp.drivers : [];
        state.busesList = busesResp?.ok && busesResp.buses ? busesResp.buses : [];

        state.busesList = state.busesList
        .map((b) => ({
            ...b,
            busId: String(b.busId || "").trim(),
            busName: b.busName && String(b.busName).trim() ? String(b.busName).trim() : `Bus ${b.busId}`,
        }))
        .filter((b) => b.busId);

        state.driversList = state.driversList
        .map((d) => ({
            ...d,
            driverId: String(d.driverId || "").trim(),
            driverName: d.driverName && String(d.driverName).trim() ? String(d.driverName).trim() : String(d.driverId || "").trim(),
        }))
        .filter((d) => d.driverName);

        refreshBusSelectOptions();
    }

    async function loadTripsForWeek() {
        clearConflictStyles();
        showConflictsPanel([]);
        clearAgenda();

        const { start, end } = getWeekRange();
        const resp = await api.weekData(start, end);

        state.trips = resp?.ok && resp.trips ? resp.trips : [];
        state.trips = state.trips
        .map((t) => ({
            ...t,
            tripKey: String(t.tripKey || "").trim(),
            departureTime: normalizeTime(t.departureTime),
            arrivalTime: normalizeTime(t.arrivalTime),
        }))
        .filter((t) => t.tripKey);

        state.tripByKey = {};
        state.trips.forEach((t) => (state.tripByKey[t.tripKey] = t));

        const asnList = resp?.ok && resp.assignments ? resp.assignments : [];
        state.assignmentsByTripKey = {};
        for (const a of asnList) {
        const k = String(a.tripKey || "").trim();
        if (!k) continue;
        (state.assignmentsByTripKey[k] ||= []).push({
            busId: String(a.busId || "").trim(),
            driver1: String(a.driver1 || "").trim(),
            driver2: String(a.driver2 || "").trim(),
        });
        }

        // render after layout settles
        scheduleAgendaReflow();
    }

    async function refreshWeekData({ silent = false } = {}) {
        try {
        if (!silent) toast("Refreshing…", "info", 1200);
        await loadTripsForWeek();
        if (!silent) toast("Up to date ✓", "success", 1200);
        } catch (e) {
        console.error(e);
        toast("Refresh failed", "danger", 2200);
        }
    }

    // ======================================================
    // Trip open/edit
    // ======================================================
    async function openTripForEdit(tripKey) {
        toastShow("Loading trip…", "loading");
        dom.saveBtn.disabled = true;

        try {
        const [tripResp, assignResp] = await Promise.all([api.getTrip(tripKey), api.getBusAssignments(tripKey)]);

        if (!tripResp?.ok) throw new Error(tripResp?.error || "Trip not found");

        const t = tripResp.trip || {};

        $("destination").value = t.destination || "";
        $("customer").value = t.customer || "";
        $("contactName").value = t.contactName || "";
        $("phone").value = t.phone || "";

        $("tripDate").value = String(t.departureDate || "").slice(0, 10);
        $("arrivalDate").value = String(t.arrivalDate || "").slice(0, 10);
        $("departureTime").value = normalizeTime(t.departureTime) || "";
        $("arrivalTime").value = normalizeTime(t.arrivalTime) || "";

        $("itineraryStatus").value = t.itineraryStatus || "";
        $("contactStatus").value = t.contactStatus || "";
        $("paymentStatus").value = t.paymentStatus || "";
        $("driverStatus").value = t.driverStatus || "";

        ["itineraryStatus", "contactStatus", "paymentStatus", "driverStatus"].forEach((id) => updateStatusSelect($(id)));

        dom.itineraryField.value = t.itinerary || "";
        $("notes").value = t.notes || "";

        setBusesNeededAndSync(t.busesNeeded ? String(t.busesNeeded) : "");
        setModeEdit(String(t.tripKey || tripKey), String(t.tripId || ""));

        // reset + apply bus assignments
        state.busRows.forEach((r) => {
            r.busSel.value = "None";
            r.d1Sel.value = "None";
            r.d2Sel.value = "None";
        });

        const assigns = assignResp?.ok && assignResp.assignments ? assignResp.assignments : [];
        assigns.forEach((a) => {
            const n = Number(a.busNumber);
            if (!n || n < 1 || n > 10) return;
            const row = state.busRows[n - 1];
            if (!row) return;

            if (a.busId) row.busSel.value = String(a.busId);
            if (a.driver1) row.d1Sel.value = String(a.driver1);
            if (a.driver2) row.d2Sel.value = String(a.driver2);
        });

        updateBusRowVisibility();
        syncBusPanelState();
        syncBusSelectEmptyState();
        refreshEmptyStateUI();

        toast("Trip loaded ✓", "success", 900);
        $("destination")?.focus?.({ preventScroll: true });
        } catch (e) {
        console.error(e);
        toast("Could not load trip", "danger", 2200);
        alert("Could not open trip for editing.");
        } finally {
        dom.saveBtn.disabled = false;
        }
    }

    // ======================================================
    // Save/Delete verification (iframe + polling)
    // ======================================================
    function startVerifyFallback() {
        if (state.verifyFallbackTimer) clearTimeout(state.verifyFallbackTimer);
        state.verifyFallbackTimer = setTimeout(() => state.pendingWrite && verifyWriteResult(), 4500);
    }
    function clearVerifyFallback() {
        if (state.verifyFallbackTimer) clearTimeout(state.verifyFallbackTimer);
        state.verifyFallbackTimer = null;
    }

    async function verifyWriteResult() {
        if (!state.pendingWrite?.tripKey) return;

        const { action, tripKey } = state.pendingWrite;
        const delays = [500, 800, 1200, 1800, 2600];

        let exists = false;
        let serverTrip = null;

        try {
        for (let i = 0; i < delays.length; i++) {
            const resp = await api.getTrip(tripKey);
            exists = !!(resp?.ok && resp.trip);
            serverTrip = exists ? resp.trip : null;
            if (exists) break;
            await delay(delays[i]);
        }

        if (action === "delete") {
            if (!exists) {
            toast("Trip deleted ✓", "success", 1400);
            toastHide(1500);

            dom.tripForm.reset();
            setModeNew();

            setSelectToPlaceholder("busesNeeded");
            setSelectToPlaceholder("itineraryStatus");
            setSelectToPlaceholder("contactStatus");
            setSelectToPlaceholder("paymentStatus");
            setSelectToPlaceholder("driverStatus");

            dom.busesNeeded.value = "";
            updateBusRowVisibility();
            refreshBusSelectOptions();

            await refreshWeekData({ silent: true });
            } else {
            toast("Delete may have failed", "danger", 2400);
            dom.action.value = dom.tripKey.value ? "update" : "create";
            }
        } else {
            if (exists) {
            const serverTripId = serverTrip?.tripId ? String(serverTrip.tripId) : "";
            if (serverTripId) {
                dom.tripId.value = serverTripId;
                setTripIdBadge(serverTripId, true);
            }

            toast("Saved ✓", "success", 1200);
            toastHide(1300);

            setModeEdit(String(dom.tripKey.value || tripKey), serverTripId || String(dom.tripId.value || ""));
            dom.action.value = "update";
            dom.deleteBtn.disabled = false;

            await refreshWeekData({ silent: true });
            } else {
            toast("Saved (syncing…) — refresh if needed", "warning", 2200);
            }
        }
        } catch (e) {
        console.error(e);
        toast("Could not verify save/delete", "danger", 2400);
        } finally {
        clearVerifyFallback();
        state.pendingWrite = null;
        dom.saveBtn.disabled = false;
        dom.action.value = dom.tripKey.value ? "update" : "create";
        }
    }

    // ======================================================
    // UI wiring + boot
    // ======================================================
    function setTripInputVisible(visible) {
        dom.tripScheduler.classList.toggle("is-hidden", !visible);
        dom.schedulerLayout.classList.toggle("is-collapsed", !visible);
        dom.tripInputBtn.textContent = visible ? "Hide Trip Input" : "Trip Input";

        // Layout changes here; schedule a stable reflow
        if (dom.agendaBody?.rows?.length) scheduleAgendaReflow();
    }

function syncEmptyStateForForm() {
  const form = dom.tripForm;
  if (!form) return;

  const fields = Array.from(
    form.querySelectorAll("input, select, textarea")
  ).filter((el) => el.id && el.type !== "hidden");

  function isEmpty(el) {
    const v = (el.value ?? "");

    if (el.tagName === "TEXTAREA") return !String(v).trim();
    if (el.tagName === "SELECT") return !String(v);
    return !String(v);
  }

  function syncOne(el) {
    el.classList.toggle("is-empty", isEmpty(el));
  }

  fields.forEach(syncOne);

  fields.forEach((el) => {
    el.addEventListener("input", () => syncOne(el));
    el.addEventListener("change", () => syncOne(el));
    el.addEventListener("blur", () => syncOne(el));
  });

  form.addEventListener("reset", () => {
    setTimeout(() => fields.forEach(syncOne), 0);
  });
}

    function loadPrefs() {
        try {
        state.weekStartsOnMonday = localStorage.getItem("weekStartMonday") === "1";
        } catch {
        state.weekStartsOnMonday = false;
        }
    }

    function wireEvents() {
        ["itineraryStatus", "contactStatus", "paymentStatus", "driverStatus"].forEach((id) => {
        const el = $(id);
        updateStatusSelect(el);
        el.addEventListener("change", () => updateStatusSelect(el));
        });

        dom.refreshBtn.addEventListener("click", () => refreshWeekData());

        dom.prevWeekBtn.addEventListener("click", () => changeWeek(-1));
        dom.nextWeekBtn.addEventListener("click", () => changeWeek(1));
        dom.weekPicker.addEventListener("change", updateWeekDates);

        dom.tripInputBtn.addEventListener("click", () => setTripInputVisible(dom.tripScheduler.classList.contains("is-hidden")));

        dom.weekStartToggle.checked = state.weekStartsOnMonday;
        dom.weekStartToggle.addEventListener("change", () => {
        state.weekStartsOnMonday = !!dom.weekStartToggle.checked;
        try {
            localStorage.setItem("weekStartMonday", state.weekStartsOnMonday ? "1" : "0");
        } catch {}

        setHeaderOrder();
        buildAgendaRows();

        // reflow immediately after rebuilding the DOM
        scheduleAgendaReflow();

        updateWeekDates();
        });

        dom.itineraryBtn.addEventListener("click", openItineraryModal);
        dom.itineraryModal.addEventListener("click", (e) => {
        if (e.target.dataset.close !== undefined) closeItineraryModal();
        });
        document.addEventListener("keydown", (e) => {
        if (!dom.itineraryModal.hidden && e.key === "Escape") closeItineraryModal();
        });
        dom.itinerarySaveBtn.addEventListener("click", closeItineraryModal);
        dom.itineraryCopyBtn.addEventListener("click", async () => {
        try {
            await navigator.clipboard.writeText(dom.itineraryModalField.value || "");
            toast("Copied ✓", "success", 900);
        } catch {
            toast("Copy failed", "danger", 1200);
        }
        });

        dom.busGrid.addEventListener("change", (e) => {
        if (e.target && e.target.tagName === "SELECT") syncBusSelectEmptyState();
        });

        dom.busesNeeded.addEventListener("input", () => {
        updateBusRowVisibility();
        syncBusPanelState();
        });
        dom.busesNeeded.addEventListener("change", () => {
        updateBusRowVisibility();
        syncBusPanelState();
        });

        $("tripDate").addEventListener("change", () => {
        const dep = $("tripDate").value;
        const arrival = $("arrivalDate");
        if (dep && arrival && !arrival.value) arrival.value = dep;
        arrival.dispatchEvent(new Event("change", { bubbles: true }));
        });

        dom.hiddenIframe.addEventListener("load", () => {
        if (!state.pendingWrite) return;
        clearVerifyFallback();
        verifyWriteResult();
        });

        dom.newBtn.addEventListener("click", () => {
        dom.tripForm.reset();
        refreshEmptyStateUI();
        setModeNew();

        setSelectToPlaceholder("busesNeeded");
        setSelectToPlaceholder("itineraryStatus");
        setSelectToPlaceholder("contactStatus");
        setSelectToPlaceholder("paymentStatus");
        setSelectToPlaceholder("driverStatus");

        dom.busesNeeded.value = "";
        updateBusRowVisibility();
        syncBusPanelState();
        refreshBusSelectOptions();

        ["itineraryStatus", "contactStatus", "paymentStatus", "driverStatus"].forEach((id) => updateStatusSelect($(id)));

        toast("Ready", "info", 900);
        });

        dom.deleteBtn.addEventListener("click", () => {
        if (!dom.tripKey.value) return;
        if (!confirm("Delete this trip?")) return;

        dom.action.value = "delete";
        dom.saveBtn.disabled = true;

        toastShow("Deleting trip…", "loading");
        state.pendingWrite = { action: "delete", tripKey: String(dom.tripKey.value) };
        startVerifyFallback();
        dom.tripForm.submit();
        });

        dom.tripForm.addEventListener("submit", (e) => {
        e.preventDefault();
        if (dom.saveBtn.disabled) return;
        if (dom.action.value === "delete") return;

        const dep = $("tripDate").value;
        const arr = $("arrivalDate").value;
        if (dep && !arr) {
            $("arrivalDate").value = dep;
            $("arrivalDate").dispatchEvent(new Event("change", { bubbles: true }));
        }

        if (dom.action.value === "create" && !dom.tripKey.value) dom.tripKey.value = safeUUID();

        $("departureTime").value = normalizeTime($("departureTime").value);
        $("arrivalTime").value = normalizeTime($("arrivalTime").value);

        toastShow(dom.action.value === "update" ? "Saving changes…" : "Saving…", "loading");
        dom.saveBtn.disabled = true;

        state.pendingWrite = { action: dom.action.value, tripKey: String(dom.tripKey.value || "") };
        startVerifyFallback();
        dom.tripForm.submit();
        });
    }

    (function boot() {
        setTripInputVisible(false);

        loadPrefs();
        dom.weekStartToggle.checked = state.weekStartsOnMonday;

        const today = new Date();
        dom.weekPicker.value = toLocalDateInputValue(today);
        state.currentDate = startOfWeek(today);

        buildBusRowsOnce();
        syncBusPanelState();

        buildAgendaRows();
        setHeaderOrder();

        syncEmptyStateForForm();
        setModeNew();

        wireEvents();

        window.addEventListener("resize", () => scheduleAgendaReflow(), { passive: true });
        window.addEventListener("orientationchange", () => scheduleAgendaReflow(), { passive: true });

        const tableWrap = document.querySelector(".week-table-container");
        if (tableWrap && "ResizeObserver" in window) {
        const ro = new ResizeObserver(() => scheduleAgendaReflow());
        ro.observe(tableWrap);
        }

        // Reflow after fonts load (Inter can subtly change widths)
        if (document.fonts?.ready) {
        document.fonts.ready.then(() => scheduleAgendaReflow());
        }

        (async function init() {
        try {
            await loadDriversAndBuses();
        } catch (e) {
            console.warn("Could not load drivers/buses yet. Using placeholders.", e);
            state.driversList = [{ driverName: "None" }, { driverName: "Driver A" }, { driverName: "Driver B" }];
            state.busesList = [{ busId: "218", busName: "Bus 218" }, { busId: "763", busName: "Bus 763" }];
            refreshBusSelectOptions();
        }
        updateWeekDates();
        })();
    })();
    </script>

  </body>
</html>
